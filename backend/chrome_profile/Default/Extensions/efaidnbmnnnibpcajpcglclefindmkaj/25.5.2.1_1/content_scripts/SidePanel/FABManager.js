/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
class FABManager{constructor(){if(FABManager.instance)return FABManager.instance;FABManager.instance=this,this.shadowRoot=null,this.hasShownSettingsMenu=!1,this.actionableCoachmark=new ActionableCoachmark,this.isFABHiddenForNow=!1,this.enableTooltipTimeout=void 0,this.registerOpenCloseListeners(),this.registerFABEnabledDisabledListeners(),this.isSidePanelOpened=!1}registerOpenCloseListeners(){chrome.runtime.onMessage.addListener((async e=>{switch(e.action){case"sidepanel_opened":this.removeFAB(),this.isSidePanelOpened=!0;break;case"sidepanel_closed":this.renderFAB(),this.isSidePanelOpened=!1}}))}async registerFABEnabledDisabledListeners(){chrome.storage.onChanged.addListener((({enableGenAIFab:e},t)=>{"local"===t&&e&&("false"===e.newValue?this.removeFAB():this.renderFAB())}))}sendAnalyticsEvent=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}};isFABRendered(){return Boolean(this.shadowRoot)}removeFAB(){this.shadowRoot?.host?.remove(),this.shadowRoot=null,this.hasShownSettingsMenu=!1}customiseFABVisibility(){let e;const t=()=>{this.isFABRendered()&&(this.removeFAB(),document.removeEventListener("scroll",t),document.addEventListener("mousemove",s))},s=async o=>{if(!this.isFABRendered()&&o.clientY>.75*window.innerHeight){if(e||this.isSidePanelOpened)return;e=setTimeout((async()=>{await GenAIWebpageEligibilityService.shouldShowTouchpoints()&&this.renderFAB({fadeIn:!0}),document.removeEventListener("mousemove",s),document.addEventListener("scroll",t),e=void 0}),200)}else e&&(clearTimeout(e),e=void 0)};document.addEventListener("scroll",t)}async shouldRenderFAB(){return await initDcLocalStorage(),"false"!==window.dcLocalStorage.getItem("enableGenAIFab")}async renderFAB(e={}){const{fadeIn:t=!1,enableHoveredState:s=!1,hoveredStateTimeout:o=7e3}=e;if(this.isFABHiddenForNow||this.actionableCoachmark.isRendered())return;if(this.isFABRendered())return;if(!await this.shouldRenderFAB())return;const i=document.createElement("div");i.id="aiFabShadowRoot",i.style.display="block",t&&(i.style.opacity="0",i.style.transition="opacity 0.4s ease-out, transform 0.4s ease-out"),this.shadowRoot=i.attachShadow({mode:"open"}),fetch(chrome.runtime.getURL("resources/SidePanel/sidePanelButton.html")).then((e=>e.text())).then((async e=>{const n=document.createElement("template");n.innerHTML=e;const a=n.content;this.shadowRoot.appendChild(a.cloneNode(!0));const r=this.shadowRoot.querySelector(".close-btn"),l=this.shadowRoot.querySelector(".acrobat-button");this.shadowRoot.querySelector(".acrobat-button-container").addEventListener("mousedown",(async()=>{this.hideSettingsMenu(),r.classList?.remove("showCloseButton"),await GenAIWebpageEligibilityService.shouldDisableTouchpoints()||(this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Clicked"]]),chrome.runtime.sendMessage({type:"open_side_panel",touchpoint:"FAB"}),chrome.runtime.sendMessage({main_op:"log-info",log:{message:"FAB clicked",url:window.location.href}}))}));const d=this.shadowRoot?.querySelector(".tooltip-text"),c=this.shadowRoot.querySelector(".tooltip-text span:first-child");await GenAIWebpageEligibilityService.shouldDisableTouchpoints()?(l.classList.add("disabled"),c.id="tooltipTextDisabled",this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Disabled"]])):this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:FabIcon:Enabled"]]),l.addEventListener("mouseenter",(()=>{r.classList.contains("showCloseButton")||r.classList.add("showCloseButton")})),l.addEventListener("mouseleave",(()=>{this.hasShownSettingsMenu||(r.classList.remove("showCloseButton"),d?.classList?.remove("show-tooltip"),l?.classList.remove("expand-acrobat-button"))})),r.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.hasShownSettingsMenu?this.hideSettingsMenu():this.showSettingsMenu()})),r.addEventListener("mousedown",(e=>{e.stopImmediatePropagation(),e.preventDefault()})),util.translateElements(".translate",this.shadowRoot),document.documentElement.appendChild(i),s&&(l?.classList.add("expand-acrobat-button"),r?.classList.add("showCloseButton"),d?.classList.add("show-tooltip"),setTimeout((()=>{r?.classList.remove("showCloseButton"),d?.classList.remove("show-tooltip"),l?.classList.remove("expand-acrobat-button")}),o)),t&&requestAnimationFrame((()=>requestAnimationFrame((()=>i.style.opacity="1"))))})),this.enableTooltipTimeout&&clearTimeout(this.enableTooltipTimeout),this.enableTooltipTimeout=setTimeout((()=>this.customiseFABVisibility()),s?o:50)}hideSettingsMenu(){this.shadowRoot.querySelector(".close-btn").classList.remove("open");const e=this.shadowRoot?.querySelector(".fab-view-settings-dialog");if(e){const e=this.shadowRoot?.querySelector(".tooltip-text");e&&(e.style.display="block");const t=this.shadowRoot.querySelector(".fab-view-settings-dialog");t?.classList?.remove("showDialog")}this.hasShownSettingsMenu=!1}async hideFabForDomain(e){await initDcLocalStorage();const t=window.dcLocalStorage.getItem("hideFabDomainList")||[];t.includes(e)||t.push(e),window.dcLocalStorage.setItem("hideFabDomainList",t)}async neverDisplayFab(){await initDcLocalStorage(),window.dcLocalStorage.setItem("enableGenAIFab","false")}showSettingsMenu(){this.shadowRoot.querySelector(".close-btn").classList.add("open"),fetch(chrome.runtime.getURL("resources/SidePanel/FABViewSettings.html")).then((e=>e.text())).then((e=>{const t=this.shadowRoot?.querySelector(".tooltip-text");t&&(t.style.display="none");const s=this.shadowRoot.querySelector(".fab-view-settings-dialog");s.innerHTML=e,s.classList.add("showDialog"),this.hasShownSettingsMenu=!0,util.translateElements(".translate",this.shadowRoot);const o=new URL(window.location.href).hostname;["hideForNow","hideFabForDomain","neverDisplayFab","preferences"].forEach((e=>{this.shadowRoot.getElementById(e)?.addEventListener("click",(async()=>{switch(e){case"hideForNow":this.isFABHiddenForNow=!0,this.removeFAB(),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:RemoveFab"]]);break;case"hideFabForDomain":this.hideFabForDomain(o),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:RemoveFabForDomain"]]),this.removeFAB();break;case"neverDisplayFab":this.neverDisplayFab(),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:NeverDisplay"]]),this.removeFAB();break;case"preferences":chrome.runtime.sendMessage({type:"open_options_page"}),this.sendAnalyticsEvent([["DCBrowserExt:SidePanel:SettingsMenu:PreferencesClicked"]])}}))}))}))}}