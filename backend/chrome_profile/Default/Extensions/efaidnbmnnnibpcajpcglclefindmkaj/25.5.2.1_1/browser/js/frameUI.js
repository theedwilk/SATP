/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{events as e}from"../../common/analytics.js";import{dcLocalStorage as t}from"../../common/local-storage.js";import{util as a}from"./content-util.js";import{privateApi as n}from"./content-privateApi.js";import{SETTINGS as s}from"../../sw_modules/settings.js";await t.init();var o,i,r=!1,d=!1;function c(e,t){e.authenticatedPDF&&1==e.authenticatedPDF&&delete e.authenticatedPDF,a.messageToMain(e),delete e.newUI,delete e.analytics,i&&(clearTimeout(i),i=null),t||"dismiss"===e.content_op||_()}function l(){a.consoleLog("Clear timer: "+i),i&&(clearTimeout(i),i=null),s.IS_ERP_READER?$(".acrobatMainDiv").stop().css("display","none"):($(".acrobatMainDiv").stop().css("opacity",1),$(".convert-status").stop().css("opacity",1))}function _(){o.content_op="dismiss",o.main_op="relay_to_content",o.newUI=!0,c(o)}function p(){$(".convert-status").addClass("hidden"),$(".progress-area").addClass("hidden")}function E(){i=null,$(".convert-status").animate({opacity:0},1500,"linear",p)}function m(){(s.TEST_MODE||s.DEBUG_MODE)&&(i=1),i||r||(i=setTimeout((function(){setTimeout(E)}),o.is_pdf?3e3:1500))}async function u(){o.main_op="open_in_acrobat",o.newUI=!0,void 0!==o.paramName&&delete o.paramName,delete o.content_op,delete o.is_viewer,delete o.click_context,delete o.dataURL;c(await a.handlePDFURL(o,!1),!0)}async function f(e){o.main_op="open_in_acrobat",o.newUI=!0,o.paramName=e,delete o.content_op,delete o.is_viewer,delete o.dataURL,delete o.click_context;c(await a.handlePDFURL(o,!1),!0)}function R(n){d||(d=!0,$(".do_acrobat").click((function(e){var t=$(e.currentTarget);l(),s.FILL_N_SIGN_ENABLED&&t.hasClass("do_acrobat_FS")?f("FillnSign"):t.hasClass("do_acrobat")&&u()})),$(".close-dialog").click((function(){if(o&&o.version){var t=e.PERSIST_PDF_MENU_CLOSED;t=s.FILL_N_SIGN_ENABLED&&"stripTextOpenFillnSign"===o.stripId?o.version===s.READER_VER?e.PERSIST_PDF_MENU_CLOSED_READER_FS:e.PERSIST_PDF_MENU_CLOSED_ACROBAT_FS:o.version===s.READER_VER?e.PERSIST_PDF_MENU_CLOSED_READER:e.PERSIST_PDF_MENU_CLOSED,a.analytics(o,t)}o.fteClosed=!1,_()})),$(".always-show").prop("checked","false"!==t.getItem("always-show-pdf-menu")),$(".always-show").click((function(){var e=$(".always-show").prop("checked")?"true":"false";t.setItem("always-show-pdf-menu",e)})))}function D(i){var d,c,_,p=!0,E=!0,D=!1,v="web2pdfPDFOpenFailedv2",C=!(0==i.version||1==i.version||i.version===s.READER_VER||i.version===s.ERP_READER_VER);i.version===s.READER_VER||(i.version,s.ERP_READER_VER);if(!(i.main_op&&["save-preferences","fetch-preferences","express-init","getFloodgateMeta","relay_to_content","local-storage-remove","log-info","google-image-preview-express-init","embedded-pdf-touch-point-config"].includes(i.main_op)||i.type&&["getWindowType","get_sidepanel_state"].includes(i.type))){if(i.test_extension)return function(e){a.consoleLog("TESTING"),a.consoleLogDir(JSON.stringify(e)),"doAcrobat"===e.test_extension&&($("persistent.do_acrobat").not(":hidden").hasClass("do_acrobat_FS")?f("FillnSign"):u()),void 0!==e.test_extension&&delete e.test_extension}(i);if(!i.authenticatedPDF)switch(i.version===s.ERP_READER_VER&&(s.IS_ERP_READER=!0),R(),delete(o=i).analytics,r=!1,$(".acrobatMainDiv").stop().css("opacity",1),a.translateElements(".translate"),1===o.version&&$("#web2pdfOpenButtonText").val(a.getTranslation("web2pdfOpenButtonTextOlder")),o.version===s.READER_VER&&$("#web2pdfOpenButtonText").val(a.getTranslation("web2pdfOpenButtonText")),$(".ui-element").addClass("hidden"),$("#action_message").text(""),function(e,t){if(s.DEBUG_MODE){var n,o=[t];for(n in e)e.hasOwnProperty(n)&&o.push("  "+n+": "+e[n]);a.consoleLog(o.join("\n"))}}(o,"Receive frame message:"),c=o.panel_op,delete o.panel_op,delete o.dataURL,delete o.click_context,delete o.is_viewer,c){case"pdf_menu":const c=t.getItem("fteDenied");if(a.isEdge()&&s.VIEWER_ENABLED&&(!C||s.VIEWER_ENABLED_FOR_ACROBAT))try{t.getItem("pdfViewer")||(t.setItem("fte","false"),t.setItem("pdfViewer","true"),n.setViewerState("enabled"),a.messageToMain({main_op:"analytics",analytics:[[e.USE_ACROBAT_IN_EDGE_AUTO_ENABLED]]}),T(o.tabId))}catch(t){a.analytics(o,e.LOCAL_STORAGE_DISABLED)}!C||s.VIEWER_ENABLED&&s.VIEWER_ENABLED_FOR_ACROBAT?!s.VIEWER_ENABLED||t.getItem("pdfViewer")||c&&10===parseInt(c)||C&&!s.VIEWER_ENABLED_FOR_ACROBAT||o.incognito?i.version<=1||!s.VIEWER_SHOW_OPEN_IN_ACRO||10!==c&&"false"!==t.getItem("pdfViewer")||($(".acrobatMainDiv").removeClass("hidden"),$(".acro-option.pdf").removeClass("hidden")):(c&&parseInt(c)>=9&&($("#acc-cancel").addClass("hidden"),$("#acc-deny").removeClass("hidden")),function(e){switch(e.fteFeatureFlag){case"dc-cv-fte-pdf-redcard":$(".acrobat-only-side-card").removeClass("hidden");break;case"dc-cv-fte-pdf-dmb":$(".acrobat-only-top-bar").removeClass("hidden");break;default:$(".acrobat-only-card").removeClass("hidden")}}(o)):($(".acrobatMainDiv").removeClass("hidden"),$(".acro-option.pdf").removeClass("hidden"),$(".acrobat-only-card").addClass("hidden")),t.getItem("pdfViewer")&&$(".acrobat-only-card").addClass("hidden"),$(".acrobatMainDiv").off("hover");break;case"error":$(".error").removeClass("hidden").text("Unexpected Error:"+o.error.name+"\nReference: "+o.error.errnum+"\n"+o.error.details);break;case"flickr":$(".action-available").removeClass("hidden"),$("#action_message").text("Create slide shows and contact sheets."),$(".special_question").removeClass("hidden"),$("#special").removeClass("hidden");break;case"status":$(".progress-area").removeClass("hidden"),$(".convert").text(o.domtitle),$(".convert-status, .convert-title").addClass("hidden"),$(".convert").removeClass("convert-button hidden"),$(".acrobatMainDiv").off("hover"),"waiting"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_WAITING),d=a.getTranslation("web2pdfStatusWaiting"),p=!1):"downloading"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_DOWNLOADING),d=a.getTranslation("web2pdfStatusDownloading"),p=!1):"in_progress"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_IN_PROGRESS),d=a.getTranslation("web2pdfStatusInProgress"),p=!1):"filelocked"===o.current_status?d=a.getTranslation("web2pdfFileLockedError"):"cancelled"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_CANCELLED),d=a.getTranslation("web2pdfStatusCancelled"),D=!0):"complete"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_COMPLETE),o.file_path?($(".convert").text(a.getTranslation("web2pdfOpenInDCButtonText")),$(".convert").addClass("convert-button")):($(".convert").empty(),$(".convert").addClass("hidden"))):"failure"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_FAILED),o.message&&(d=o.message,d=$("<div/>").text(d).html()),E=!1):"noacrobat"===o.current_status?(a.analytics(o,e.TREFOIL_HTML_CONVERT_NO_ACROBAT),d=a.getTranslation("web2pdfUnsupportedAcrobatVersion"),E=!1):"unknown"===o.current_status?(d=a.getTranslation("web2pdfStatusUnknownFailure"),E=!1):"pdf_downloading"===o.current_status?(d=a.getTranslation("web2pdfStatusDownloadingPDF"),p=!1):"pdf_failure"===o.current_status?(o.version===s.READER_VER?a.analytics(o,e.PERSIST_PDF_DOWNLOAD_FAILED_READER):a.analytics(o,e.PERSIST_PDF_DOWNLOAD_FAILED),v="web2pdfStatusUnknownFailure",E=!1):"pdf_downloaded"===o.current_status?(d=a.getTranslation("web2pdfPDFOpening"),p=!1):"pdf_opened"===o.current_status?(E=!0,"web2pdfPDFOpened"):"pdf_open_failed"===o.current_status&&(E=!1,p=!0,v="web2pdfPDFOpenFailedv2"),d&&($(".in-process").removeClass("hidden"),$(".convert-title").removeClass("hidden"),$(".convert-title").html(d)),p?(delete o.panel_op,$(".acrobatMainDiv").hover(l,m),$(".actions").removeClass("hidden"),$(".in-process").addClass("hidden"),_=o.is_pdf?".acro-option.pdf":".acro-option.html",$(_).removeClass("hidden"),$(".convert").removeClass("convert-busy"),$(".convert-status").removeClass("hidden"),$(".convert-status").stop().css("opacity",1),E?($(".progress-area").addClass("hidden"),$(".convert").removeClass("convert-busy"),$(".convert-status").addClass("hidden")):($(".convert-status-icon").removeClass("icon-success"),$(".convert-status-icon").addClass("icon-error"),$(".convert-status-title").text(a.getTranslation(v)),$(".convert").addClass("hidden")),D&&($(".convert-status").addClass("hidden"),$(".convert").addClass("hidden")),m()):(r=!0,$(".actions").addClass("hidden"),$(".convert").addClass("convert-busy"))}}}function v(t){var n,o,i;if(void 0!==(n=t)&&(void 0!==n.stripId&&delete n.stripId,void 0!==n.paramName&&delete n.paramName),s.FILL_N_SIGN_ENABLED=t.isFillnSignEnabled,s.SHAREPOINT_ENABLED=t.isSharePointEnabled,!0===(o=t,i=!1,s.FILL_N_SIGN_ENABLED?void 0===o.stripId&&(void 0!==o.url&&!0===a.isPDFForm(o.url)?(o.stripId="stripTextOpenFillnSign",i=!0):o.stripId="stripTextOpenAcrobat"):o.stripId="stripTextOpenAcrobat",i)){$(".acrobatMainDiv").width(205),$(".acro-option.pdf").addClass("do_acrobat_FS");{let a={tab:t.tab,main_op:"analytics",analytics:[]};t.version===s.READER_VER?a.analytics.push(e.PDF_FORM_DETECTED_READER):a.analytics.push(e.PDF_FORM_DETECTED_ACROBAT),c(a,!0)}}$(".acro-option.pdf").attr("id",t.stripId),D(t)}function T(e){setTimeout((()=>{chrome.tabs.reload(e)}),100)}a.isChrome()&&$((function(){R()})),a.addMainListener(D),$((function(){window.location.search&&(o=JSON.parse(decodeURIComponent(window.location.search.split("=")[1])),s.TEST_MODE&&window.addEventListener("message",(function(e){v(e.data)}),!1),v(o),"false"===t.getItem("ViewResultsPref")?!1:($(".do_set_open_pref").addClass("open-pdf-in-acrobat"),!0),$("#acc-cancel, #sideCardCloseIcon, #acc-top-bar-close").on("click",(function(){let n,s=t.getItem("repromptCount");switch(this.id){case"acc-top-bar-close":n=e.PERSIST_PDF_MENU_DMB_CANCEL;break;case"sideCardCloseIcon":n=e.PERSIST_PDF_MENU_RED_CARD_CANCEL;break;default:n=e.PERSIST_PDF_MENU_FTE_CANCEL}s?a.messageToMain({main_op:"analytics",analytics:[[n,{REPROMPT:"Reprompt"}]]}):a.messageToMain({main_op:"analytics",analytics:[[n,{":REPROMPT":""}]]});let i=t.getItem("fteDenied");if(i=i&&parseInt(i)>=6?parseInt(i)+1:6,10===i){let e=Date.now();t.setItem("reprompt-user-timestamp",e)}t.setItem("persist-menu-closed",i-1),t.setItem("fteDenied",i),o.fteClosed=!0,_()})),$("#acc-deny").on("click",(function(){let n=t.getItem("fteDenied");if(t.getItem("repromptCount")?a.analytics(o,e.PERSIST_PDF_MENU_FTE_REPROMPT_DENIED):a.analytics(o,e.PERSIST_PDF_MENU_FTE_DENIED),n=n&&parseInt(n)>=6?parseInt(n)+1:6,t.setItem("fteDenied",n),10===n){let e=Date.now();t.setItem("reprompt-user-timestamp",e)}o.fteClosed=!0,_()})),$("#acc-ok, #top-bar-acc-ok, #side-card-acc-ok").on("click",(function(){let s=!1;try{let o,i=t.getItem("repromptCount");switch(this.id){case"top-bar-acc-ok":o=e.PERSIST_PDF_MENU_DMB_CONFIRM;break;case"side-card-acc-ok":o=e.PERSIST_PDF_MENU_RED_CARD_CONFIRM;break;default:o=e.PERSIST_PDF_MENU_FTE_ACCEPTED}i?a.messageToMain({main_op:"analytics",analytics:[[o,{REPROMPT:"Reprompt"}]]}):a.messageToMain({main_op:"analytics",analytics:[[o,{":REPROMPT":""}]]}),t.getItem("pdfViewer")||t.setItem("viewer-enabled-source","ownership-consent"),t.setItem("pdfViewer","true"),n.setViewerState("enabled"),s=!0}catch(t){a.messageToMain({main_op:"analytics",analytics:[[e.LOCAL_STORAGE_DISABLED]]})}s&&T()})),$("#acc-top-bar-close").on("click",(function(){$(".acrobat-only-top-bar").addClass("hidden")})),$("#fteSideCard").hover((function(){$(".fteSideCard-content-body").toggleClass("toggled")})))}));