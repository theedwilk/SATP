/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{communicate as e}from"./communicate.js";import{util as t}from"./util.js";import{analytics as n,events as o}from"../common/analytics.js";import{SETTINGS as s}from"./settings.js";import{dcLocalStorage as a,dcSessionStorage as r}from"../common/local-storage.js";import{floodgate as i}from"./floodgate.js";import{privateApi as c}from"./private-api.js";import{common as l}from"./common.js";import{userSubscription as m}from"./user-subscription.js";import{userDetailsAcrobat as d}from"./acrobatUserDetails.js";import{downloadBannerExcludeList as u,LOCAL_FTE_WINDOW as I,OFFSCREEN_DOCUMENT_PATH as E,ADOBE_URL as p}from"../common/constant.js";import{CACHE_PURGE_SCHEME as g,EXPRESS as f}from"./constant.js";import{versionChecks as h}from"./handleVersionChecks.js";import{sendPingEventHandler as _,registerUninstallUrl as w}from"../common/util.js";import{loggingApi as T}from"../common/loggingApi.js";import{offscreenActions as N}from"./offscreen-actions.js";import{viewerModuleUtils as A}from"./viewer-module-utils.js";import{launchExpress as L,toggleExpressTouchpoints as O}from"./express.js";import{indexedDBScript as S}from"../common/indexDB.js";import{floodgateMigration as v}from"./floodgateMigration.js";var b,C,D=new Promise((function(e){C=e})),R={},M=()=>e.getModule("acro-web2pdf"),F=()=>e.getModule("acro-gstate"),P=["http://*/*","https://*/*"];async function U(){!async function(){const[e,t]=await Promise.all([chrome.tabs.query({url:"https://mail.google.com/*"}),chrome.tabs.query({url:"https://drive.google.com/*"})]);e?.length>0&&n.event("DCBrowserExt:ExtensionUpdate:Gmail:Open"),t?.length>0&&n.event("DCBrowserExt:ExtensionUpdate:GDrive:Open")}();for(const e of chrome.runtime.getManifest().content_scripts){const t=await chrome.tabs.query({url:e.matches});for(const n of t)(n.url.includes("mail.google.com")||n.url.includes("drive.google.com"))&&(e.css&&chrome.scripting.insertCSS({files:e.css,target:{tabId:n.id}}),chrome.scripting.executeScript({files:e.js,target:{tabId:n.id,allFrames:e.all_frames}}))}}async function y(e){try{chrome.sidePanel.setOptions({enabled:!1}),e&&(e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version?(t.verCmp(e.previousVersion,"15.1.3.30")<0&&await async function(){let e;try{const n=await chrome.tabs.query({});await Promise.allSettled(n.map((({id:e})=>chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectCopyLSIframe.js"]})))),await t.sleep(300),e=await chrome.runtime.sendMessage({main_op:"copy-ls"}),n.map((({id:e})=>chrome.tabs.sendMessage(e,{content_op:"remove-lsCopy"}).catch((()=>null))))}catch(e){}finally{"succeed"!==e?(a.setItem("retryOnNextPage",!0),n.event(n.e.LOCAL_STORAGE_MIGRATION_FAILED)):n.event(n.e.LOCAL_STORAGE_MIGRATION_SUCCESS)}}(),a.getItem("installVersion")||a.setItem("installVersion",e.previousVersion),a.setItem("installType",e.reason),a.getItem("thirdPartyCookieChecked")&&a.removeItem("thirdPartyCookieChecked"),a.getItem("tpcBlockAnalyticsEnable")&&a.removeItem("tpcBlockAnalyticsEnable")):e.reason===chrome.runtime.OnInstalledReason.INSTALL&&((()=>{const e=`https://chromewebstore.google.com/detail/*/${chrome.runtime.id}*`,t=`https://microsoftedge.microsoft.com/addons/detail/*/${chrome.runtime.id}*`;chrome.tabs.query({url:[e,t]},(e=>{if(chrome.runtime.lastError)b=null;else for(let t in e){const n=new URLSearchParams(new URL(e[t].url).search);if(n.has("mv")){b=encodeURIComponent(n.get("mv"));break}}}))})(),a.setItem("installVersion",chrome.runtime.getManifest().version),a.setItem("installType",e.reason)),a.getItem("offlineSupportDisable")||a.setItem("offlineSupportDisable",!0)),D.then((({env:o,msg:r})=>{if(a.setItem("installSource",o.installType),w(),S.clearExpiredBlobBuffers().catch((e=>{T.error({message:"Failed to clear old file buffer entries on startup",error:e})})),S.clearFileHashOldEntries().catch((e=>{T.error({message:"Failed to clear old blob cache entries on startup",error:e})})),"true"===r.repromptDone&&n.event(n.e.EXTENSION_REPROMPT_TRACKING,{REASON:e.reason,TYPE:o.installType}),e.reason===chrome.runtime.OnInstalledReason.UPDATE&&e.previousVersion!==chrome.runtime.getManifest().version)U(),v.init(),n.event(n.e.EXTENSION_UPDATE,{installReason:e.reason,previousVersion:e.previousVersion||"none"});else if(e.reason===chrome.runtime.OnInstalledReason.INSTALL||e.previousVersion===chrome.runtime.getManifest().version){switch(U(),n.event(n.e.EXTENSION_INSTALLED,{installReason:e.reason,previousVersion:e.previousVersion||"none"}),n.logEventOnce(n.e.EXTENSION_INSTALLED_NEW,{storageKey:"installAnalyticsLogged",installReason:e.reason,previousVersion:e.previousVersion||"none"}),o.installType){case"admin":n.event(n.e.EXTENSION_INSTALLED_ADMIN);break;case"development":n.event(n.e.EXTENSION_INSTALLED_DEVELOPMENT);break;case"other":n.event(n.e.EXTENSION_INSTALLED_OTHER);break;case"normal":c.isInstalledViaUpsell().then((e=>{if(e)n.event(n.e.EXTENSION_INSTALLED_UPSELL);else{n.event(n.e.EXTENSION_INSTALLED_DIRECT);let e="store_direct";b&&(e=decodeURIComponent(b)),n.event(n.e.EXTENSION_INSTALLED_SOURCE,{SOURCE:e})}}));break;case"sideload":n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED),r.installMonth&&r.installYear?n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:r.installMonth,YEAR:r.installYear}):n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_MONTH_YEAR,{MONTH:"None",YEAR:"None"}),s.IS_READER&&"win"===s.OS&&n.event(n.e.EXTENSION_INSTALLED_SIDE_LOADED_SOURCE,{SOURCE:r.source});break;default:n.event(n.e.EXTENSION_INSTALLED_DEFAULT)}!function(e){"false"!==a.getItem("fte")&&setTimeout((()=>{chrome.storage.managed.get("OpenHelpx",(function(o){const s=!o||"false"!==o.OpenHelpx;n.event(s?n.e.VIEWER_FTE_OPEN_HELPX_ENABLED:n.e.VIEWER_FTE_OPEN_HELPX_DISABLED),function(){try{a.getItem("pdfViewer")||(a.setItem("viewer-enabled-source","ownership-install"),a.setItem("pdfViewer","true"),c.setViewerState("enabled"),t.isEdge()?(m.initiateUserPolling(),n.event(n.e.USE_ACROBAT_IN_EDGE_AUTO_ENABLED)):n.event(n.e.USE_ACROBAT_IN_CHROME_AUTO_ENABLED))}catch(e){n.event(n.e.LOCAL_STORAGE_DISABLED)}}(),a.setItem("fte","false");const r=t.isEdge()&&("admin"===e.installType||"sideload"===e.installType);s&&!r&&async function(){let e=chrome.i18n.getMessage("@@ui_locale");["ca","da","en_GB","es","fi","hr","it","ko","nl","pt_BR","ru","sl","tr","zh_CN","cs","de","en_US","eu","fr","hu","ja","nb","pl","ro","sk","sv","uk","zh_TW"].includes(e)||(e="en_US");const n=t.isEdge()?"Edge":"Chrome";return`${l.getWelcomePdfUrlHost()}/dc-chrome-extension/mv/${e}/Acrobat-for-${n}.pdf`}().then((e=>t.createTab(e,(e=>{const t=(new Date).getTime();function o(t,s){e.id==t&&"complete"===s.status&&(n.event(n.e.WELCOME_PDF_LOADED),chrome.tabs.onUpdated.removeListener(o))}R={...e,timestamp:t},chrome.tabs.onUpdated.addListener(o)}))))}))}),2e3)}(o)}}))}catch(e){}}function x(){try{if(navigator.onLine||!1===a.getItem("offlineSupportDisable")){const e=a.getItem("pdfViewer"),t=a.getItem("killSwitch"),o=a.getItem("cdnUrl");"false"===e&&"on"===t&&async function(e){const t=new AbortController,n=t.signal;let o=!1;setTimeout((()=>{o||t.abort()}),5e3);const s=await fetch(e,{signal:n});if(o=!0,200===s.status)return await s.text();return new Error(s.statusText)}(o).then((e=>{-1===e.toString().indexOf("<meta name='killSwitch' content='off'/>")&&-1===e.toString().indexOf('<meta name="killSwitch" content="off"/>')||(a.setItem("pdfViewer",!0),c.setViewerState("enabled"),a.setItem("killSwitch","off"),n.event(n.e.VIEWER_KILL_SWITCH_OFF_SUCCESS))})).catch((e=>{n.event(n.e.VIEWER_KILL_SWITCH_OFF_FAILED)}))}}catch(e){n.event(n.e.VIEWER_KILL_SWITCH_OFF_FAILED)}}function B(e){return t&&t.isChromeOnlyMessage(e)&&t.isEdge()&&(e+="Edge"),t&&t.getTranslation?t.getTranslation(e):chrome.i18n.getMessage(e)}function V(e){return(e.title||B("web2pdfUntitledFileName")).replace(/[<>?:|\*"\/\\'&\.]/g,"")}function W(e,n){if(!e&&!n)return!1;try{const t=e.pageUrl||n.url,o=new URL(t);if(o.protocol&&["http:","https:"].includes(o.protocol))return!0}catch(e){t.consoleError(e)}return!1}async function k(e,t){chrome.tabs.sendMessage(t.id,{type:"removeActionableCoachmark"}),a.setItem("touchpoint",e.touchpoint),await chrome.sidePanel.open({tabId:t.id})}function j(e,t){_(),"convertPageContextMenu"===e.menuItemId?function(e,t){W(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_PAGE),M().handleConversionRequest({tabId:t.id,caller:F().web2pdfCaller.MENU,action:F().web2pdfAction.CONVERT,context:F().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:V(t)}))}(e,t):"appendPageContextMenu"===e.menuItemId?function(e,t){W(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_PAGE),M().handleConversionRequest({tabId:t.id,caller:F().web2pdfCaller.MENU,action:F().web2pdfAction.APPEND,context:F().web2pdfContext.PAGE,url:e.pageUrl||t.url,domtitle:V(t)}))}(e,t):"convertLinkTargetToPDFContextMenu"===e.menuItemId?function(e,t){W(e,t)&&(n.event(n.e.CONTEXT_MENU_CONVERT_LINK),M().handleConversionRequest({tabId:t.id,caller:F().web2pdfCaller.MENU,action:F().web2pdfAction.CONVERT,context:F().web2pdfContext.LINK,url:e.linkUrl,domtitle:V(t)}))}(e,t):"appendLinkTargetToExistingPDFContextMenu"===e.menuItemId?function(e,t){W(e,t)&&(n.event(n.e.CONTEXT_MENU_APPEND_LINK),M().handleConversionRequest({tabId:t.id,caller:F().web2pdfCaller.MENU,action:F().web2pdfAction.APPEND,context:F().web2pdfContext.LINK,url:e.linkUrl,domtitle:V(t)}))}(e,t):(Object.values(f.VERBS).includes(e.menuItemId.replace("ContextMenu",""))||"expressMenu"===e.menuItemId)&&function(e,t){if(!W(e,t))return;const o=new URL(t.url).hostname;"expressMenu"===e.menuItemId?e.intent="editImage":e.intent=e?.menuItemId?.replace("ContextMenu",""),n.event(n.e.CONTEXT_MENU_EXPRESS_VERB,{domain:o,TARGET:e?.linkUrl?"Link":"Image",VERB:e?.intent}),a.setItem(f.CONTEXT_MENU_INTERACTION_DONE,"true"),e.touchpoint="ContextMenu",L(e,t)}(e,t)}function X(){const e="true"===a.getItem("pdfViewer")?"enabled":"disabled";c.setViewerState(e)}function H(e){const t=e.UsageMeasurement,n=t&&"false"===t.newValue?"false":"true";a.setItem("ANALYTICS_OPT_IN_ADMIN",n)}function G(){const e=a.getItem("pdfViewer");let t="neverTaken";return"true"===e?t="enabled":"false"===e&&(t="disabled"),t}async function q(){try{const e=await chrome.extension.isAllowedFileSchemeAccess(),{tabId:t,url:s}=a.getItem("localFileFteData");a.removeItem("localFileFteData");const r=a.getItem("LocalFileAccessTouchpointsFromViewer");a.removeItem("LocalFileAccessTouchpointsFromViewer");const i=a.getItem("LocalFileAccessBannerChallengerTouchpointsFromViewer");a.removeItem("LocalFileAccessBannerChallengerTouchpointsFromViewer");const c=a.getItem("LocalFileAccessBannerControlTouchpointsFromViewer");a.removeItem("LocalFileAccessBannerControlTouchpointsFromViewer");const l=a.getWithTTL("downloadBanner");if(a.removeItem("downloadBanner"),e&&(t||r||l)){const{url:e}=t?await chrome.tabs.get(t):{};if(e===s||r||l){if(r)n.event(o.LOCAL_FILE_ACCESS_TOUCHPOINT_PERMISSION_GRANTED),i?n.event(o.LOCAL_FILE_ACCESS_BANNER_CHALLENGER_TOUCHPOINT_PERMISSION_GRANTED):c&&n.event(o.LOCAL_FILE_ACCESS_BANNER_CONTROL_TOUCHPOINT_PERMISSION_GRANTED);else if(l){n.event(o.DOWNLOAD_BANNER_PERMISSION_GRANTED);const e=a.getItem("lastOpenTabId");await chrome.scripting.executeScript({target:{tabId:e},files:["content_scripts/injectBannerIframe.js"]}),chrome.tabs.sendMessage(e,{panel_op:"load-downloadBanner",showToast:!0}),n.event(o.DOWNLOAD_BANNER_TOAST_SHOWN),setTimeout((()=>{chrome.tabs.sendMessage(e,{content_op:"dismissBanner"})}),5e3)}else n.event(o.LOCAL_FTE_PERMISSION_GRANTED);!function(){const e=a.getItem("loadedTabsInfo");let t=e?.tabsInfo||[];if(t.length){const e=a.getItem("lastOpenTabId");a.removeItem("lastOpenTabId"),n.event(n.e.REOPENED_TABS_ON_LOCAL_FILE_ACCESS),t=t.sort(((e,t)=>e.index-t.index));const o=[];let s={},r={};t.forEach((e=>{const t=e.url||e.pendingUrl;t.includes("file:///")||o.push(chrome.tabs.create({url:t,index:e.index,active:!1,windowId:e.windowId}))})),Promise.allSettled(o).then((n=>{n.forEach(((n,o)=>{if(n.reason&&n.reason?.message?.includes("No window with id")){T.error({message:"Error in reopening tab",error:n.reason?.message});const e=t[o].windowId,a=t[o].url;s[e]=s[e]?[...s[e],a]:[a]}e&&n?.value?.id&&(r[n.value.id]=t[o].id,e===t[o].id&&setTimeout((()=>{chrome.tabs.highlight({tabs:n.value.index,windowId:n.value.windowId});const e=a.getItem("settingsWindow");e&&(chrome.windows.remove(e.id),a.removeItem("settingsWindow"),chrome.tabs.sendMessage(n.value.id,{content_op:"showLocalFileAccessToast"}))}),2e3))})),a.setItem("tabIdMap",r);for(const n in s)chrome.windows.create({url:s[n],focused:!1}).then((o=>{if(e){for(const s of o.tabs){const o=s.url||s.pendingUrl;r[s.id]=t.find((e=>e.url===o&&e.windowId===Number(n)))?.id,r[s.id]===e&&setTimeout((()=>{chrome.tabs.highlight({tabs:s.index,windowId:s.windowId});const e=a.getItem("settingsWindow");e&&(chrome.windows.remove(e.id),a.removeItem("settingsWindow"),chrome.tabs.sendMessage(s.id,{content_op:"showLocalFileAccessToast"}))}),2e3)}a.setItem("tabIdMap",r)}}))})),a.removeItem("loadedTabsInfo")}}(),t&&await chrome.tabs.reload(t);const e=await chrome.tabs.query({url:"file:///*"});for(let t in e){const{id:n,url:o}=e[t];o.toLowerCase().endsWith(".pdf")&&chrome.tabs.reload(n)}const s=a.getItem("settingsWindow");s&&!r&&(chrome.windows.remove(s.id),a.removeItem("settingsWindow"),setTimeout((()=>{t&&chrome.tabs.sendMessage(t,{content_op:"showLocalFileAccessToast"})}),2e3))}}else a.removeItem("loadedTabsInfo")}catch(e){t.consoleError(e)}}async function Y(o){A.setCommonItems(),(async()=>{a.getItem("appLocale")||a.setItem("appLocale",a.getItem("viewer-locale")||t.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")))})(),""!==a.getItem("acrobat-gsuite-touch-points")&&""===a.getItem("acrobat-touch-points-in-other-surfaces")&&(a.setItem("acrobat-touch-points-in-other-surfaces",a.getItem("acrobat-gsuite-touch-points")),a.removeItem("acrobat-gsuite-touch-points")),c.isMimeHandlerAvailable().then((e=>{e?r.getItem("startupComplete")||t.mimeReloadAllTabs():q()})),setTimeout(X,1e4),function(){try{t.isEdge()&&a.setItem("IsRunningInEdge","true")}catch(e){}}(),async function(){if(!a.getItem("ANALYTICS_OPT_IN_ADMIN")){const e=await chrome.storage.managed.get("UsageMeasurement"),t=e&&"false"===e.UsageMeasurement?"false":"true";a.setItem("ANALYTICS_OPT_IN_ADMIN",t)}}(),async function(){const e=await chrome.storage.managed.get("DisableGenAI"),t=e&&"true"===e.DisableGenAI?"true":"false";a.setItem("DISABLE_GENAI_BY_ADMIN",t)}();const l="dc-cv-startup-new-analytics";i.hasFlag(l,g.NO_CALL).then((e=>{if(e){const e=i.getFeatureMeta(l);if(e)try{const t=JSON.parse(e);if(t.cachingTime){const e=parseInt(t.cachingTime,10);n.logEventOnce(n.e.EXTENSION_STARTUP_NEW,{storageKey:"startupNewEventLastLogged",timePeriod:e,ownershipStatus:G()})}}catch(e){}}}));const m=await h(),{repromptDone:u}=m??{};a.getItem("adobeYoloEnable")&&s.ADOBE_YOLO_ENABLED&&!a.getWithTTL("adobe-yolo-freeze")&&d.updateUserDetails(),C({env:o,msg:m}),r.getItem("startupComplete")||(x(),function(t){const n=0==t||1==t&&!1===e.NMHConnStatus||t==s.READER_VER||t==s.ERP_READER_VER;chrome.contextMenus.removeAll((function(){s.IS_READER||n||(chrome.contextMenus.create({id:"convertPageContextMenu",title:B("web2pdfConvertPageContextMenu"),contexts:["page"],documentUrlPatterns:P}),chrome.contextMenus.create({id:"appendPageContextMenu",title:B("web2pdfAppendPageContextMenu"),contexts:["page"],documentUrlPatterns:P}),O(a.getItem("express-touch-points")))}))}(m.ver),"true"!==u&&!0!==u||n.logEventOnce(n.e.ENABLED_AFTER_READER_REPROMPT,{storageKey:"repromptAnalyticsLogged"}),setTimeout((()=>{n.event(n.e.EXTENSION_STARTUP,{ownershipStatus:G()})}),5e3),r.setItem("startupComplete",!0),async function(){if("true"!==a.getItem("pdfViewer"))return!1;const e=Date.now();let t=6048e5;const n="dc-cv-offscreen-wp-grace-period";if(!await i.hasFlag(n,g.NO_CALL))return!0;const o=i.getFeatureMeta(n);if(o)try{const e=JSON.parse(o);e.gracePeriod&&(t=parseInt(e.gracePeriod,10))}catch(e){}const s=parseInt(a.getItem("lastPdfOpenTimestamp"),10);return s?e-s<=t:(a.setItem("lastPdfOpenTimestamp",e),!0)}().then((e=>{e&&N.setupWorkerOffscreen({startup:!0})})))}function K(e){const{id:t,timestamp:o}=R,s=(new Date).getTime();e===t&&s-o<=15e3&&n.event(n.e.WELCOME_PDF_TAB_CLOSED);const r=a.getItem("signInExperimentShown");if(r){const{currTabId:t,timestamp:o}=JSON.parse(r),i=s-o,c="true"===a.getItem("signInExperimentSuppressed");e===t&&i<=15e3&&!c&&n.event(n.e.SIGN_IN_PROMPT_TAB_CLOSED),a.removeItem("signInExperimentShown"),a.removeItem("signInExperimentSuppressed")}}const $=e=>{const{height:t,width:n}=I;return{height:t,width:n,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-n)+e.left)}},z=async({windowId:e})=>{const t=await chrome.windows.get(e);if("fullscreen"===t?.state||"locked-fullscreen"===t?.state)return;const{tabId:n,url:o}=a.getItem("localFileFteData"),[s]=await chrome.tabs.query({currentWindow:!0,active:!0}),r=a.getItem("localFteWindow");if(s&&s.id===n&&s.url===o){const{height:e,width:n,top:o,left:s}=$(t);await chrome.windows.update(r?.id,{height:e,width:n,left:s,top:o,focused:!0})}};let J=!1;const Z=async n=>{const o=await chrome.windows.get(n.windowId);if("fullscreen"===o?.state||"locked-fullscreen"===o?.state)return;a.getItem("rc")&&!a.getItem("localFteCounterResetNew")&&(a.removeItem("localFteCount"),a.removeItem("localFteCooldown"),a.removeItem("localFteCounterReset"),a.setItem("localFteCounterResetNew",!0));const s=await i.hasFlag("dc-cv-local-file-fte"),r=await(async()=>{const e=t.isEdge(),n=a.getWithTTL("localFteCooldown"),o=a.getItem("localFteCount")||0,s=a.getItem("localFteDontShowAgain"),r=await chrome.extension.isAllowedFileSchemeAccess();return!(e||r||s||n||o>=20)})();if(s&&n.url.toLowerCase().startsWith("file://")&&n.url.toLowerCase().endsWith(".pdf")&&r&&!J){const{height:t,width:s,top:r,left:i}=$(o);a.setItem("localFileFteData",{tabId:n.id,url:n.url}),J=!0;const c=await chrome.windows.create({height:t,width:s,left:i,top:r,focused:n.active,type:"popup",url:chrome.runtime.getURL("browser/js/local-fte.html")});a.setItem("localFteWindow",c);const l=c?.tabs?.[0]?.id;l&&setTimeout((()=>{chrome.tabs.setZoom(l,1)}),500),e.registerHandlers({closeLocalFte:()=>chrome.windows.remove(c.id)})}},Q=e=>{const t=a.getItem("localFteWindow");e===t?.id&&(J=!1)},ee=async e=>{const{tabId:t}=a.getItem("localFileFteData");if(t===e){const e=a.getItem("localFteWindow");chrome.windows.remove(e?.id)}},te=e=>{const t=a.getItem("isAllowedLocalFileAccess"),{filename:o,id:s}=e||{};if(o&&s){let e=a.getItem("downloadCount")||0;a.setItem("downloadCount",++e),t||chrome.downloads.search({id:s},(async t=>{const{mime:o,referrer:s,finalUrl:r}=t[0],c=(s||r).split("/")[2];"application/pdf"===o&&(c===chrome.runtime.id?chrome.tabs.query({active:!0,currentWindow:!0},(e=>{chrome.tabs.sendMessage(e[0].id,{main_op:"downloadFileSuccess"})})):!u.includes(c)&&e>=3&&(async()=>{if(!await i.hasFlag("dc-cv-download-banner",g.NO_CALL))return!1;a.getItem("downloadBannerFlag")||(a.setItem("downloadBannerFlag",!0),n.event(n.e.DOWNLOAD_BANNER_ENABLED));const e=a.getItem("downloadBannerData");if(e){const{count:t,lastShown:n,doNotShow:o}=e;if(o||t>=10)return!1;const s=t>=3?12096e5:864e5;if((new Date).getTime()-n<s)return!1}return!0})().then((e=>{e&&chrome.tabs.query({active:!0,currentWindow:!0},(e=>{e[0]?.id&&(chrome.tabs.sendMessage(e[0].id,{panel_op:"load-downloadBanner"}),n.event(n.e.DOWNLOAD_BANNER_SHOWN),(()=>{const e=a.getItem("downloadBannerData")||{};e.count=(e.count||0)+1,e.lastShown=(new Date).getTime(),a.setItem("downloadBannerData",e),e.count>=10&&n.event(n.e.DOWNLOAD_BANNER_MAX_LIMIT_SHOWN)})())}))})))}))}};e.registerHandlers({themeChange:w,reRegisterUninstallUrl:w,localeChange:e=>w({locale:e.locale}),updateLoadedTabsInfo:(e,t)=>{const n=a.getItem("loadedTabsInfo");let o=n?.tabsInfo||[];const s=t.tab;if(n.tabsInfo){const e=o.findIndex((e=>e.id==s.id));-1===e?o.push(s):o[e]={...s}}else o=[s];a.setItem("loadedTabsInfo",{tabsInfo:o})}});export{Y as startup,y as registerActions,K as onWelcomeTabRemoved,j as contextMenuOnClickHandler,H as updateAnalyticsOptInAdmin,z as refocusLocalFteWindow,Z as openLocalFteWindow,ee as onLocalFileClosed,Q as onLocalFteWindowClosed,k as startQAWithWebpage,te as onDownloadChanged};