/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as n,dcSessionStorage as r}from"../common/local-storage.js";import{loggingApi as s}from"../common/loggingApi.js";import{CACHE_PURGE_SCHEME as a,EXPRESS as o,EXPRESS_CONTEXT_MENU_ENABLED_VERBS as c}from"./constant.js";import{floodgate as i}from"./floodgate.js";import{util as l}from"./util.js";import{viewerModuleUtils as m}from"./viewer-module-utils.js";import{common as p}from"./common.js";import{expressIndexedDBScript as E}from"../common/expressindexedDB.js";import{removeExperimentCodeForAnalytics as g,setExperimentCodeForAnalytics as d}from"../common/experimentUtils.js";let u=!1;const x={},S="expressMenu",f={"dc-cv-express-context-menu":"EC","dc-cv-express-standalone":"EL","dc-cv-express-standalone-control":"ELC","dc-cv-express-whatsapp-preview":"EWP","dc-cv-express-whatsapp-preview-control":"EWPC","dc-cv-express-gmail-native-viewer":"EGN","dc-cv-express-gmail-native-viewer-control":"EGNC","dc-cv-express-context-menu-single-cta":"ECS","dc-cv-express-context-menu-single-cta-control":"ECSC","dc-cv-express-edit-image-v2":"EI2","dc-cv-express-edit-image-v2-control":"EI2C","dc-cv-express-google-image-preview":"EGI","dc-cv-express-google-image-preview-control":"EGIC"},I="cleanUpExpressAssetMemoryMap",_="cleanUpExpressIndexedDB",v={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},h={[o.VERBS.EFFECTS_IMAGE]:"add-effects",[o.VERBS.CROP_IMAGE]:"crop-image",[o.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[o.VERBS.INSERT_OBJECT]:"insert-object",[o.VERBS.REMOVE_OBJECT]:"remove-object"};async function w(e){const t=Date.now(),n=await fetch(e);if(!n.ok)throw new Error(`Response not in 2xx range. Status: ${n.status}`);const r=await n.blob();return new Promise(((e,n)=>{const s=new FileReader;s.readAsDataURL(r),s.onloadend=()=>{const n=s.result,r=Date.now()-t;e({base64data:n,imageDownloadTime:r})},s.onerror=n}))}async function R(e){if(!await i.hasFlag(e))return!1;const t=i.getFeatureMeta(e);if(t)try{const e=JSON.parse(t);if(e.minExtVer&&l.verCmp(e.minExtVer,chrome.runtime.getManifest().version)>0)return!1}catch(e){}return!0}function b(e){const t=["en-US","en-GB"],n=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));switch(e){case"dc-cv-express-google-image-preview":case"dc-cv-express-google-image-preview-control":return t.includes(n);default:return!0}}function A(e){return h[e]??"edit-image"}function T(e){return(r.getItem(o.EXPRESS_SESSIONS)||{})[e]}async function O(e,t){const n=Date.now(),s=new URL(t.url).hostname,a=e.srcUrl,c=t.id,i=e.intent,m=e.touchpoint,p=await async function(){return await R("dc-cv-express-standalone")?o.VARIANT.LOE:o.VARIANT.MODAL}(),E=l.uuid(),g=r.getItem(o.EXPRESS_SESSIONS)||{};return g[E]={pageDomain:s,imageURL:a,tabId:c,intent:i,touchpoint:m,variant:p,clickTimeStamp:n},r.setItem(o.EXPRESS_SESSIONS,g),E}async function P(e,t){const n=await O(e,t);await M(n)}function L(e){const t=r.getItem(o.EXPRESS_SESSIONS)||{};return Object.keys(t).find((n=>{const s=t[n];return s.tabId===e&&!s.fetchedFromContentScript&&s.variant===o.VARIANT.MODAL&&(t[n].fetchedFromContentScript=!0,r.setItem(o.EXPRESS_SESSIONS,t),!0)}))}async function M(a){const c=T(a);let i;const m=c?.pageDomain;try{if(i=c.intent,c.variant===o.VARIANT.LOE){const e=c.clickTimeStamp,t=e+864e5;E.storeExpressAssetInfoInIndexedDB(a,c.imageURL,t,e),chrome.alarms.get(_,(e=>{e||chrome.alarms.create(_,{periodInMinutes:720})})),x[a]={bufferPromise:w(c.imageURL),ttl:Date.now()+6e5,clickTimeStamp:e,domain:m},chrome.alarms.get(I,(e=>{e||chrome.alarms.create(I,{periodInMinutes:10})}));const r=new URL(p.getExpressURLs().webAppUrl);r.searchParams.append("expressSessionId",a),r.searchParams.append("referrer",o.REFERRER);const s=A(c.intent);r.searchParams.append("editAction",s),r.searchParams.append("extId",function(){const e=Object.keys(v).filter((e=>v[e].includes(chrome.runtime.id)));return e.length>0?e[0]:"release"}());const i=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));r.searchParams.append("locale",i),"true"===n.getItem("adobeInternal")&&r.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:r.href,active:!0})}else!function(e){let t=r.getItem(o.TAB_IDS_WHERE_MODAL_LOADING)||[];t.push(e),r.setItem(o.TAB_IDS_WHERE_MODAL_LOADING,t)}(c.tabId),await chrome.scripting.executeScript({target:{tabId:c.tabId},files:["content_scripts/express-content-script.js"]})}catch(n){V(c?.tabId,!0),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:i,eventContext:n.toString(),expressTouchpoint:c?.touchpoint,domain:m}),s.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+n.toString()})}}async function D(r){if(!x[r])return async function(n){let r,a,c;const i=T(n),l=await E.getExpressAssetInfoFromIndexedDB(n);if(!l)return s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${o.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:o.RESPONSE_STATUS.FAILED,errorCode:o.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};r=l.url,a=l.clickTimeStamp;try{c=(await w(r)).base64data}catch(n){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:i?.pageDomain,expressTouchpoint:i?.touchpoint}),s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`}),{status:o.RESPONSE_STATUS.FAILED,errorCode:o.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:a}}return{status:o.RESPONSE_STATUS.SUCCESS,buffer:c,clickTimeStamp:a}}(r);{const a=T(r)?.touchpoint,c=x[r]?.domain,i=x[r].clickTimeStamp,l=Date.now()-i;try{const{base64data:e,imageDownloadTime:t}=await x[r].bufferPromise,a=Date.now()-i;"true"===n.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+l),console.log("Image Download Time "+t),console.log("Time required to handover to express "+a));const m={imageDownloadTime:t,timeRequiredToHandoverToExpress:a,expressCommunicationReceivedTime:l,imageSize:e.length};return s.info({message:o.PERF_METRIC_LOG_MESSAGE,...m}),{status:o.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:i,domain:c}}catch(n){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:n.toString(),domain:c,expressTouchpoint:a}),s.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${n.toString()}`});const r=o.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:o.RESPONSE_STATUS.FAILED,errorCode:r,clickTimeStamp:i,domain:c}}}}function N(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow="auto"}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function C(){const e="true"===n.getItem("adobeInternal"),t=n.getItem("installSource");return e||"admin"!==t}async function y(){const e=C();for(const t of Object.keys(f)){const n=f[t];e&&await R(t)&&b(t)?d(n):g(n)}g("Exp_Mod"),g("Exp_Loe")}async function F(e){const t=["http://*/*","https://*/*"];if((await G(e)).enableExpressContextMenu){if(!u){u=!0;if(await i.hasFlag("dc-cv-express-context-menu-single-cta"))B(S,l.getTranslation("expressEditImageParentContextMenuExperiment"),["image"],t);else{const e=B(S,l.getTranslation("expressEditImageParentContextMenu"),["image"],t);chrome.contextMenus.create({id:"poweredByAdobeExpress",parentId:e,title:l.getTranslation("expressEditImagePoweredByExpressContextMenu"),contexts:["image"],enabled:!1,documentUrlPatterns:t}),chrome.contextMenus.create({id:"separatorForExpressMenu",parentId:e,type:"separator",contexts:["image"],documentUrlPatterns:t}),c.forEach((n=>{const r=n+"ContextMenu";B(r,l.getTranslation(r),["image"],t,e)}))}}const e=await i.hasFlag("dc-cv-enable-splunk-logging",a.NO_CALL);m.enableSplunk(e)}else!async function(){if(u){u=!1;await i.hasFlag("dc-cv-express-context-menu-single-cta")||(chrome.contextMenus.remove("poweredByAdobeExpress"),chrome.contextMenus.remove("separatorForExpressMenu"),Object.keys(c).forEach((e=>{const t=c[e]+"ContextMenu";chrome.contextMenus.remove(t)}))),chrome.contextMenus.remove(S)}}()}async function G(r){let s={enableExpressContextMenu:!1,enableExpressOptionsPagePreference:!1,enableExpressTooltip:!1};const a=await i.hasFlag("dc-cv-express-context-menu")||await R("dc-cv-express-context-menu-ab")||await R("dc-cv-express-standalone"),c=await i.hasFlag("dc-cv-express-context-menu-tooltip"),l=await i.hasFlag("dc-cv-express-context-menu-pref-value");if(null!=r&&""!==r||null!=(r=n.getItem("express-touch-points"))&&""!==r||(r=l),await y(),a&&C()&&("true"!==n.getItem("express-context-menu-fg-enabled-analytics-logged")&&(n.setItem("express-context-menu-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_CONTEXT_MENU_FG_ENABLED)),s.enableExpressOptionsPagePreference=!0,r&&"false"!==r)){s.enableExpressContextMenu=!0;const e="true"===n.getItem(o.CONTEXT_MENU_INTERACTION_DONE);s.enableExpressTooltip=!e&&c}return s}function B(e,t,n,r,s){return chrome.contextMenus.create({id:e,parentId:s,title:t,contexts:n,documentUrlPatterns:r})}function U(n){const r=V(n);for(let n=0;n<r;n++){const n="Tab closed before express modal opened";s.error({message:"Error executing express verb",error:n}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:n})}}function V(e,t=!1){let n=0,s=r.getItem(o.TAB_IDS_WHERE_MODAL_LOADING)||[];return s.length>0&&s.includes(e)&&(s=s.filter((r=>{if(r===e){if(n++,t&&1===n)return!1;if(!t)return!1}return!0})),r.setItem(o.TAB_IDS_WHERE_MODAL_LOADING,s)),n}async function j(){const r={enableWhatsappPreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},s=await i.hasFlag("dc-cv-express-whatsapp-preview"),a=await i.hasFlag("dc-cv-express-whatsapp-preview-control");let o=n.getItem("express-touch-points");return o=""===o||o,await y(),s&&C()?("true"!==n.getItem("express-whatsapp-preview-fg-enabled-analytics-logged")&&(n.setItem("express-whatsapp-preview-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_PREVIEW_MENU_FG_ENABLED)),r.enableExpressOptionsPagePreference=!0,o&&"false"!==o&&(r.enableWhatsappPreviewExpressMenu=!0)):a&&C()&&"true"!==n.getItem("express-whatsapp-preview-fg-control-enabled-analytics-logged")&&(n.setItem("express-whatsapp-preview-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_WHATSAPP_PREVIEW_MENU_FG_CONTROL_ENABLED)),r}async function X(){const r={enableGmailNVExpressMenu:!1,enableExpressOptionsPagePreference:!1},s=await i.hasFlag("dc-cv-express-gmail-native-viewer"),a=await i.hasFlag("dc-cv-express-gmail-native-viewer-control");let o=n.getItem("express-touch-points");return o=""===o||o,await y(),s&&C()?("true"!==n.getItem("express-gmail-native-viewer-fg-enabled-analytics-logged")&&(n.setItem("express-gmail-native-viewer-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_NATIVE_VIEWER_FG_ENABLED)),r.enableExpressOptionsPagePreference=!0,o&&"false"!==o&&(r.enableGmailNVExpressMenu=!0)):a&&C()&&"true"!==n.getItem("express-gmail-nv-fg-control-enabled-analytics-logged")&&(n.setItem("express-gmail-nv-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_GMAIL_NATIVE_VIEWER_FG_CONTROL_ENABLED)),r}async function k(){const r={enableGoogleImagePreviewExpressMenu:!1,enableExpressOptionsPagePreference:!1},s=["en-US","en-GB"],a=l.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale")),o=await i.hasFlag("dc-cv-express-google-image-preview"),c=await i.hasFlag("dc-cv-express-google-image-preview-control");let m=n.getItem("express-touch-points");return m=""===m||m,await y(),s.includes(a)&&(o&&C()?("true"!==n.getItem("express-google-image-preview-fg-enabled-analytics-logged")&&(n.setItem("express-google-image-preview-fg-enabled-analytics-logged","true"),e.event(t.EXPRESS_GOOGLE_IMAGE_PREVIEW_MENU_FG_ENABLED)),r.enableExpressOptionsPagePreference=!0,m&&"false"!==m&&(r.enableGoogleImagePreviewExpressMenu=s.includes(a))):c&&C()&&"true"!==n.getItem("express-google-image-preview-fg-control-enabled-analytics-logged")&&(n.setItem("express-google-image-preview-fg-control-enabled-analytics-logged","true"),e.event(t.EXPRESS_GOOGLE_IMAGE_PREVIEW_MENU_FG_CONTROL_ENABLED))),r}chrome.alarms.onAlarm.addListener((function(e){e&&e.name===I&&(Object.keys(x).forEach((e=>{x[e]?.ttl<Date.now()&&delete x[e]})),0===Object.keys(x).length&&chrome.alarms.clear(I))})),chrome.alarms.onAlarm.addListener((function(e){e&&e.name===_&&E.removeExpressAssetInfoFromIndexedDB().then((()=>{E.getExpressAssetCount().then((e=>{0===e&&chrome.alarms.clear(_)}))}))}));export{M as executeExpressVerb,N as closeExpress,F as toggleExpressTouchpoints,G as isExpressContextMenuEnabled,D as getExpressAssetResponse,w as imageUrlToBase64,A as verbNameToIntent,V as removeTabIdFromUnloadedExpressTabs,U as expressModalTabCloseListener,j as isWhatsappPreviewExpressMenuEnabled,X as isGmailNativeViewerExpressMenuEnabled,k as isGoogleImagePreviewExpressMenuEnabled,L as getModalSessionId,T as getExpressSession,P as launchExpress};